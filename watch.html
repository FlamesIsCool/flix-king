<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Watch — cinefx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0b0c" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3CradialGradient id='p' cx='50%25' cy='50%25' r='50%25'%3E%3Cstop stop-color='%23ff2e77'/%3E%3Cstop offset='1' stop-color='%23e41861'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='28' fill='url(%23p)'/%3E%3Ctext x='50%25' y='54%25' text-anchor='middle' font-size='30' font-family='Inter,Arial' fill='white' font-weight='900'%3EC%3C/text%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{ --pink:#ff2e77; --pink-2:#e41861; }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; background:#000; color:#fff; font-family:"Inter", ui-sans-serif, system-ui }

    /* Top bar – minimal, solid matte, never blocks player clicks */
    .top{
      position:fixed; inset-inline:0; top:0; z-index:2;
      display:flex; align-items:center; gap:10px; padding:8px 12px;
      background:rgba(10,10,11,.9);
      border-bottom:1px solid rgba(255,255,255,.06);
      pointer-events:none;
    }
    .title{ font-weight:900; letter-spacing:.4px }
    .sp{ flex:1 }
    .btn{ pointer-events:auto; display:inline-flex; align-items:center; gap:8px; font-weight:800;
      padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#1b1b1d; cursor:pointer; color:#fff }
    .btn:hover{ background:#222226; border-color:rgba(255,255,255,.16) }

    /* Stage */
    .stage{ position:fixed; inset:0; display:grid; place-items:center }
    iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; z-index:0 }

    /* Loading veil – never intercepts clicks */
    .veil{ position:absolute; inset:0; display:grid; place-items:center; background:#000; transition:.25s;
      z-index:1; pointer-events:none; opacity:1 }
    .veil.hidden{ opacity:0; visibility:hidden }
    .spinner{ width:44px; height:44px; border:4px solid rgba(255,255,255,.18); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* Progress (silent; used for Continue Watching UI on home) */
    .bar{ position:fixed; left:0; right:0; top:0; height:2px; background:linear-gradient(90deg, var(--pink), var(--pink-2)); width:0; z-index:3; pointer-events:none }
  </style>
</head>
<body>
  <div class="top">
    <button class="btn" onclick="history.back()">⬅ Back</button>
    <div class="sp"></div>
    <div class="title">cinefx</div>
  </div>

  <div class="bar" id="bar"></div>

  <div class="stage">
    <div class="veil" id="veil"><div class="spinner"></div></div>
    <iframe id="frame" allowfullscreen></iframe>
  </div>

  <script>
    // Query params
    const qp = new URLSearchParams(location.search);
    const id = qp.get("id");
    let type = qp.get("type")==="tv" ? "tv" : "movie";
    let qsSeason = parseInt(qp.get("season")||"");
    let qsEpisode = parseInt(qp.get("episode")||"");

    // Config
    const API_KEY = "d9f0568167a608d0700093444b0c2da7";
    const frame = document.getElementById("frame");
    const veil  = document.getElementById("veil");
    const bar   = document.getElementById("bar");

    // Continue Watching (localStorage)
    const key = (id,type)=> `${type}:${id}`;
    const getMap = ()=> { try{return JSON.parse(localStorage.getItem("fk-continue")||"{}");}catch{return{}} };
    const setMap = (m)=> localStorage.setItem("fk-continue", JSON.stringify(m));
    const saveProgress = ({id,type,progress,currentTime,duration})=>{
      const m = getMap(); m[key(id,type)] = {id,type,progress,currentTime,duration,ts:Date.now()}; setMap(m);
    };
    const clearProgress=(id,type)=>{ const m=getMap(); delete m[key(id,type)]; setMap(m); };

    // Embed builders
    function setSrcMovie(progressSec){
      const base = `https://www.vidking.net/embed/movie/${id}?color=ff2e77&autoPlay=true`;
      frame.src = progressSec ? `${base}&progress=${Math.floor(progressSec)}` : base;
    }
    function setSrcTv(season, episode, progressSec){
      const base = `https://www.vidking.net/embed/tv/${id}/${season}/${episode}?color=ff2e77&autoPlay=true&nextEpisode=true&episodeSelector=true`;
      frame.src = progressSec ? `${base}&progress=${Math.floor(progressSec)}` : base;
    }

    // Find first valid TV S/E if none provided (prevents redirect)
    async function populateEpisodes(tvId, seasonNumber){
      const r = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${API_KEY}`);
      const d = await r.json();
      return (d.episodes||[]).filter(e=>e.episode_number>0);
    }
    async function firstValidSeasonEpisode(tvId){
      const tv = await fetch(`https://api.themoviedb.org/3/tv/${tvId}?api_key=${API_KEY}`).then(r=>r.json());
      const seasons = (tv.seasons||[]).filter(s=>s.season_number>0);
      const pool = seasons.length ? seasons : (tv.seasons||[]);
      if(Number.isInteger(qsSeason) && qsSeason>0 && Number.isInteger(qsEpisode) && qsEpisode>0){
        return { season: qsSeason, episode: qsEpisode };
      }
      for(const s of pool.sort((a,b)=>a.season_number-b.season_number)){
        const eps = await populateEpisodes(tvId, s.season_number);
        if(eps.length) return { season: s.season_number, episode: eps[0].episode_number };
      }
      return { season: 1, episode: 1 };
    }

    async function boot(){
      try{
        if(type==="tv"){
          const { season, episode } = await firstValidSeasonEpisode(id);
          setSrcTv(season, episode);
        }else{
          setSrcMovie();
        }
      }catch(e){
        if(type!=="tv"){ setSrcMovie(); }
      }
    }

    // Receive progress from Vidking and update bar + storage
    window.addEventListener("message", (event)=>{
      try{
        const payload = typeof event.data === "string" ? JSON.parse(event.data) : event.data;
        if(!payload || payload.type!=="PLAYER_EVENT") return;
        const d = payload.data || {};
        if(["timeupdate","seeked","play"].includes(d.event)){
          const pct = Math.min(100, Math.max(0, d.progress || (d.duration? (d.currentTime/d.duration*100):0)));
          bar.style.width = pct + "%";
          saveProgress({ id, type, progress:pct, currentTime:d.currentTime||0, duration:d.duration||0 });
        }
        if(d.event==="ended"){ bar.style.width="100%"; clearProgress(id,type); }
      }catch{}
    });

    // Ensure veil never blocks clicks
    frame.addEventListener("load", ()=>{
      veil.className = "veil hidden";
      setTimeout(()=> veil.remove(), 250);
    });

    boot();
  </script>
</body>
</html>